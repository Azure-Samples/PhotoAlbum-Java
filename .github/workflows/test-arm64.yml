name: Test Oracle on ARM64

on:
  workflow_dispatch:  # Manual trigger only (click "Run workflow" button in GitHub Actions)

jobs:
  test-arm64:
    runs-on: macos-latest  # macOS 14 with Apple Silicon (native ARM64)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Docker on macOS
        run: |
          brew install docker docker-compose
          brew install colima
          colima start --cpu 2 --memory 4
      
      - name: Start Oracle Database (ARM64)
        run: |
          docker-compose up -d oracle-db
          echo "Waiting for Oracle to be healthy..."
          timeout 300 bash -c 'until docker-compose ps | grep -q "healthy"; do sleep 10; echo "Still waiting..."; done' || true
      
      - name: Check Oracle logs
        if: always()
        run: |
          docker-compose logs oracle-db
      
      - name: Test Oracle connectivity
        run: |
          docker-compose exec -T oracle-db bash -c "echo 'SELECT 1 FROM DUAL;' | sqlplus -s photoalbum/photoalbum@FREEPDB1" || echo "Connection test failed"
      
      - name: Verify ARM64 architecture
        run: |
          docker inspect photoalbum-oracle --format='{{.Platform}}'
          docker exec photoalbum-oracle uname -m
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v
